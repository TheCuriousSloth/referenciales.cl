# Base de Datos de Referenciales para Tasaci√≥n üìä

[![Project Status: Active Development](https://img.shields.io/badge/status-active%20development-brightgreen)](https://github.com/TheCuriousSloth/referenciales.cl) 
[![License: MIT](https://img.shields.io/badge/License-MIT-blue.svg)](https://opensource.org/licenses/MIT)
[![API Status](https://img.shields.io/badge/API%20P%C3%BAblica-Disponible-success)](https://referenciales.cl/api/public/docs)

Sistema de gesti√≥n para referenciales de tasaci√≥n inmobiliaria construido con Next.js 15 (App Router), PostgreSQL + PostGIS y autenticaci√≥n Google OAuth.

## Tabla de Contenidos
- [Descripci√≥n](#descripci√≥n)
- [üÜï API P√∫blica](#-api-p√∫blica)
- [Estado del Proyecto](#estado-del-proyecto)
- [Caracter√≠sticas Clave](#caracter√≠sticas-clave)
- [Tech Stack](#tech-stack)
- [Sistema de Autenticaci√≥n](#sistema-de-autenticaci√≥n)
- [Gu√≠a Definitiva de Autenticaci√≥n](#gu√≠a-definitiva-de-autenticaci√≥n)
- [Prerrequisitos](#prerrequisitos)
- [Instalaci√≥n y Configuraci√≥n](#instalaci√≥n-y-configuraci√≥n)
- [Variables de Entorno](#variables-de-entorno)
- [Uso](#uso)
- [Base de Datos](#base-de-datos)
- [Problemas Conocidos](#problemas-conocidos)
- [Contribuciones](#contribuciones)
- [Licencia](#licencia)

## Descripci√≥n
Este proyecto busca crear una base de datos colaborativa ü§ù de referenciales inmobiliarios para facilitar el trabajo de tasaci√≥n en Chile. Permite a usuarios autenticados gestionar informaci√≥n relevante, incluyendo datos espaciales.

## üÜï API P√∫blica

**¬°Nueva caracter√≠stica!** Ahora puedes acceder a los datos del mapa de referenciales inmobiliarias **sin autenticaci√≥n** a trav√©s de nuestra API p√∫blica.

### üöÄ Acceso R√°pido

```javascript
// Obtener datos del mapa
fetch('https://referenciales.cl/api/public/map-data')
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      console.log('Referencias:', result.data);
    }
  });
```

### üìä Endpoints Disponibles

- **üìç Datos del Mapa**: `GET /api/public/map-data`
  - Par√°metros: `comuna`, `anio`, `limit`
  - Ejemplo: `/api/public/map-data?comuna=santiago&limit=50`

- **‚öôÔ∏è Configuraci√≥n**: `GET /api/public/map-config`
  - Metadatos de la API y configuraci√≥n del mapa

- **üìö Documentaci√≥n**: `GET /api/public/docs`
  - Documentaci√≥n completa con ejemplos de c√≥digo

### ‚ú® Caracter√≠sticas de la API

- ‚úÖ **Sin autenticaci√≥n** - Completamente p√∫blica
- ‚úÖ **CORS habilitado** - Funciona desde cualquier dominio
- ‚úÖ **Datos en tiempo real** - Directamente desde la base de datos
- ‚úÖ **Filtros disponibles** - Comuna, a√±o, l√≠mite de resultados
- ‚úÖ **Informaci√≥n detallada** - Monto, superficie, CBR, ubicaci√≥n, etc.

### üó∫Ô∏è Integraci√≥n con React Leaflet

```tsx
import { MapContainer, TileLayer, CircleMarker, Popup } from 'react-leaflet';
import { useEffect, useState } from 'react';

const ReferencialMap = () => {
  const [points, setPoints] = useState([]);

  useEffect(() => {
    fetch('https://referenciales.cl/api/public/map-data')
      .then(res => res.json())
      .then(result => {
        if (result.success) setPoints(result.data);
      });
  }, []);

  return (
    <MapContainer center={[-33.4489, -70.6693]} zoom={10}>
      <TileLayer url="https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png" />
      {points.map(point => (
        <CircleMarker key={point.id} center={[point.lat, point.lng]}>
          <Popup>
            <div>
              <h3>{point.predio}</h3>
              <p><strong>Comuna:</strong> {point.comuna}</p>
              <p><strong>Monto:</strong> {point.monto}</p>
              <p><strong>Superficie:</strong> {point.superficie} m¬≤</p>
            </div>
          </Popup>
        </CircleMarker>
      ))}
    </MapContainer>
  );
};
```

### üìñ Documentaci√≥n Completa

- **üìö API Docs**: [https://referenciales.cl/api/public/docs](https://referenciales.cl/api/public/docs)
- **üîß Gu√≠a de Integraci√≥n**: [`docs/integration-examples/integration-guide.md`](docs/integration-examples/integration-guide.md)
- **‚öõÔ∏è Componentes React**: [`docs/integration-examples/ReferencialMapComponent.tsx`](docs/integration-examples/ReferencialMapComponent.tsx)
- **üåê Ejemplo Vanilla JS**: [`docs/integration-examples/vanilla-example.html`](docs/integration-examples/vanilla-example.html)

### üß™ Probar la API

```bash
# Bash/Linux
./scripts/test-api-public.sh

# PowerShell/Windows
.\scripts\test-api-public.ps1

# cURL
curl "https://referenciales.cl/api/public/map-data?comuna=santiago&limit=5"
```

---

## Estado del Proyecto
üöß **En desarrollo activo** üöß

### Foco Actual:
- ‚úÖ **API P√∫blica Implementada** - Lista para integraci√≥n externa üéâ
- Reforzar el sistema de autenticaci√≥n con Google üîí
- Optimizar el formulario de ingreso de referenciales üìù
- Corregir errores conocidos (ver [Problemas Conocidos](#problemas-conocidos))

## Caracter√≠sticas Clave
-   **üÜï API P√∫blica:** Acceso sin autenticaci√≥n a datos del mapa para integraci√≥n externa üåê.
-   **Autenticaci√≥n Segura:** Inicio de sesi√≥n exclusivo con Google OAuth 2.0 üîê.
-   **Panel de Administraci√≥n:** Interfaz protegida para usuarios autenticados üõ°Ô∏è.
-   **Gesti√≥n CRUD:** Crear, leer, actualizar y eliminar referenciales inmobiliarios üìã.
-   **Datos Espaciales:** Uso de PostGIS para almacenar y gestionar coordenadas geogr√°ficas üó∫Ô∏è.
-   **Interfaz Moderna:** Construida con Next.js App Router y Tailwind CSS.

## Tech Stack
-   **Framework:** Next.js 15.2.0 (App Router)
-   **Lenguaje:** TypeScript
-   **Estilos:** Tailwind CSS
-   **Base de Datos:** PostgreSQL con extensi√≥n PostGIS
-   **ORM:** Prisma
-   **Autenticaci√≥n:** NextAuth.js v4 (Google Provider)
-   **UI:** React
-   **üÜï API P√∫blica:** REST endpoints con CORS habilitado

## Sistema de Autenticaci√≥n

El proyecto utiliza **NextAuth.js v4.24.11** para la autenticaci√≥n, con las siguientes caracter√≠sticas:

- **Proveedor √∫nico:** Google OAuth 2.0 para simplificar el proceso de registro e inicio de sesi√≥n
- **Adaptador de base de datos:** @next-auth/prisma-adapter para persistencia en PostgreSQL
- **Estrategia de sesi√≥n:** JWT para mejor rendimiento
- **Estado actual:** Configuraci√≥n estable y funcional en entornos Linux y Windows
- **üÜï Rutas p√∫blicas:** API p√∫blica disponible sin autenticaci√≥n en `/api/public/*`

### Notas sobre migraci√≥n futura

Se planea migrar a **Auth.js v5** (NextAuth.js v5) en el futuro para aprovechar:

- Mejor integraci√≥n con Next.js App Router
- Mejor soporte para Edge Runtime
- API m√°s intuitiva con funciones como `signIn` y `signOut` exportadas directamente

Consulta el archivo `auth-notes.md` para obtener detalles completos sobre la configuraci√≥n actual y el plan de migraci√≥n.

## Gu√≠a Definitiva de Autenticaci√≥n

> **¬øProblemas con el login, bucles infinitos o errores de OAuth?**
>
> Consulta la [Gu√≠a Definitiva para la Prevenci√≥n y Soluci√≥n de Bucles de Autenticaci√≥n](docs/GUIA-DEFINITIVA-AUTENTICACION.md) para diagn√≥stico, checklist y buenas pr√°cticas. Es el manual oficial para debugging y referencia de autenticaci√≥n en este proyecto.

## Prerrequisitos
-   Node.js (v18 o superior recomendado)
-   npm o yarn
-   Git
-   Una instancia de PostgreSQL con la extensi√≥n PostGIS habilitada.

## Instalaci√≥n y Configuraci√≥n

1.  **Clonar el repositorio:**
    ```bash
    git clone https://github.com/TheCuriousSloth/referenciales.cl.git
    cd referenciales.cl
    ```

2.  **Instalar dependencias:**
    ```bash
    npm install
    # o
    # yarn install
    ```

3.  **Configurar Variables de Entorno:**
    Crea un archivo `.env` en la ra√≠z del proyecto y copia el contenido de `.env.example` (si existe) o a√±ade las variables necesarias (ver [Variables de Entorno](#variables-de-entorno)).

4.  **Sincronizar Esquema de Base de Datos:**
    Este comando aplica el esquema de Prisma a tu base de datos. ¬°√ösalo con cuidado en producci√≥n! (Considera usar `prisma migrate dev` para desarrollo con migraciones).
    ```bash
    npx prisma db push
    ```

5.  **Generar Cliente Prisma:**
    Este comando genera el cliente Prisma basado en tu esquema.
    ```bash
    npx prisma generate
    ```

6.  **üÜï Probar la API P√∫blica:**
    ```bash
    # Iniciar servidor de desarrollo
    npm run dev

    # En otra terminal, probar la API
    ./scripts/test-api-public.sh
    # o en Windows PowerShell:
    .\scripts\test-api-public.ps1
    ```

## Variables de Entorno
Aseg√∫rate de definir las siguientes variables en tu archivo `.env`:

-   `POSTGRES_PRISMA_URL`: Cadena de conexi√≥n a tu base de datos PostgreSQL (incluyendo usuario, contrase√±a, host, puerto, nombre de base de datos y `schema=public`). Ejemplo: `postgresql://USER:PASSWORD@HOST:PORT/DATABASE?schema=public`
-   `GOOGLE_CLIENT_ID`: Tu Client ID de Google Cloud Console para OAuth.
-   `GOOGLE_CLIENT_SECRET`: Tu Client Secret de Google Cloud Console para OAuth.
-   `NEXTAUTH_URL`: La URL base de tu aplicaci√≥n (ej. `http://localhost:3000` para desarrollo).
-   `NEXTAUTH_SECRET`: Una cadena secreta aleatoria para firmar los tokens de sesi√≥n (puedes generar una con `openssl rand -base64 32`).

## Uso

-   **Ejecutar en modo desarrollo:**
    ```bash
    npm run dev
    # o
    # yarn dev
    ```
    Abre [http://localhost:3000](http://localhost:3000) en tu navegador.

-   **üÜï Probar API P√∫blica:**
    ```bash
    # Probar endpoints de la API p√∫blica
    curl http://localhost:3000/api/public/map-data
    curl http://localhost:3000/api/public/map-config
    curl http://localhost:3000/api/public/docs
    ```

-   **Crear build de producci√≥n:**
    ```bash
    npm run build
    # o
    # yarn build
    ```

-   **Ejecutar en modo producci√≥n:**
    ```bash
    npm run start
    # o
    # yarn start
    ```

## Base de Datos üóÑÔ∏è
Usamos PostgreSQL + Prisma ORM con la extensi√≥n PostGIS. El esquema actual (`prisma/schema.prisma`) incluye:
-   **User**: Informaci√≥n de usuarios autenticados üë§
-   **Referencial**: Datos de referenciales inmobiliarios, con campos `lat` y `lng` para datos espaciales üó∫Ô∏è.
-   **Account**: Gesti√≥n de cuentas OAuth üîê (manejado por NextAuth).
-   **Session**: Gesti√≥n de sesiones de usuario (manejado por NextAuth).
-   **VerificationToken**: Tokens para verificaci√≥n (ej. email, manejado por NextAuth).
-   **Conservador**: Informaci√≥n sobre Conservadores de Bienes Ra√≠ces.

### üÜï API P√∫blica de Datos
Los datos de la tabla `referenciales` est√°n disponibles p√∫blicamente a trav√©s de la API, excluyendo informaci√≥n sensible como nombres de compradores/vendedores.

## Problemas Conocidos üêõ
-   En vista m√≥vil, `next/image` no optimiza correctamente la imagen de la p√°gina de inicio üì±.
-   Al crear un nuevo referencial, aparece un mensaje duplicado de √©xito üì®.
-   **Paginaci√≥n Rota en Producci√≥n:** La tabla de Referenciales no se actualiza correctamente al navegar entre p√°ginas en el entorno de producci√≥n. Investigando activamente. üöß

*(Se recomienda usar el issue tracker de GitHub para gestionar estos problemas)*

## üÜï Scripts √ötiles

```bash
# Probar API p√∫blica en desarrollo
npm run test:api          # Ejecuta test-api-public.sh
npm run test:api:windows  # Ejecuta test-api-public.ps1

# Ejecutar tests unitarios
npm run test              # Jest tests

# Base de datos
npm run db:push           # Aplicar schema a DB
npm run db:generate       # Generar cliente Prisma
npm run db:studio         # Abrir Prisma Studio
```

## Contribuciones ü§ù
¬°Las contribuciones son bienvenidas! Si encuentras un error o tienes una sugerencia, por favor abre un issue. Si quieres contribuir con c√≥digo, si√©ntete libre de hacer un Pull Request.

### üÜï Para Desarrolladores Externos
Si quieres integrar la API p√∫blica en tu proyecto:

1. **Revisa la documentaci√≥n**: [https://referenciales.cl/api/public/docs](https://referenciales.cl/api/public/docs)
2. **Usa los ejemplos**: Disponibles en [`docs/integration-examples/`](docs/integration-examples/)
3. **Reporta issues**: Si encuentras problemas con la API p√∫blica

## Licencia üìÑ
Este proyecto est√° licenciado bajo la [Licencia MIT](https://opensource.org/licenses/MIT).

---

## üåü ¬øUsas nuestra API P√∫blica?

Si est√°s integrando la API p√∫blica de referenciales.cl en tu proyecto, ¬°nos encantar√≠a saberlo! Contacta con nosotros:

- **GitHub Issues**: Para reportar problemas o sugerir mejoras
- **Discussions**: Para compartir casos de uso o hacer preguntas
- **Ejemplos de integraci√≥n**: Contribuye con ejemplos para otros desarrolladores

**API P√∫blica URL**: `https://referenciales.cl/api/public`
